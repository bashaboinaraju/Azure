- name: Reset Azure AD User Password
  hosts: localhost
  gather_facts: no
  vars:
    access_token: "eyJ0eXAiOiJKV1QiLCJub25jZSI6Im5fQkdDX3o3ZFo2eG4tVFpPdlRydmtsUVNaNmc5NWFtQzR6dUhRU1BiVEkiLCJhbGciOiJSUzI1NiIsIng1dCI6IkpETmFfNGk0cjdGZ2lnTDNzSElsSTN4Vi1JVSIsImtpZCI6IkpETmFfNGk0cjdGZ2lnTDNzSElsSTN4Vi1JVSJ9.eyJhdWQiOiIwMDAwMDAwMy0wMDAwLTAwMDAtYzAwMC0wMDAwMDAwMDAwMDAiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC8xOTVlODk2OS1jODUzLTQ3YjQtODNkMC0zNmUwNDRkODM5MjMvIiwiaWF0IjoxNzQxNjAyMDMwLCJuYmYiOjE3NDE2MDIwMzAsImV4cCI6MTc0MTY4ODczMCwiYWNjdCI6MCwiYWNyIjoiMSIsImFjcnMiOlsicDEiXSwiYWlvIjoiQVZRQXEvOFpBQUFBWjFnNzJNWjRoL2Nvd0s4RmdmQnh2ZUYzTlY2d201a093eHZYUW0rN3ptZC9pcGZEUExab1BjYVU1MEdmZEZ5NnppTE9hRGtUWFBaQ1dYUTlIbG5SaElXTTNYSDF0Mkx0U3p1TVJ0Szlla3M9IiwiYW1yIjpbInB3ZCIsIm1mYSJdLCJhcHBfZGlzcGxheW5hbWUiOiJHcmFwaCBFeHBsb3JlciIsImFwcGlkIjoiZGU4YmM4YjUtZDlmOS00OGIxLWE4YWQtYjc0OGRhNzI1MDY0IiwiYXBwaWRhY3IiOiIwIiwiaWR0eXAiOiJ1c2VyIiwiaXBhZGRyIjoiMTY1LjIyNS4xMjAuMTUwIiwibmFtZSI6Ikdsb2JhbCBBZG1pbiIsIm9pZCI6ImQ4MTA4OTIyLWE1ZTEtNDE1Yi05NzRiLTkwMjJiYTRlNDkyZSIsInBsYXRmIjoiMyIsInB1aWQiOiIxMDAzMjAwNDQ0NTJBOUUzIiwicmgiOiIxLkFVb0FhWWxlR1ZQSXRFZUQwRGJnUk5nNUl3TUFBQUFBQUFBQXdBQUFBQUFBQUFBdUFlZEtBQS4iLCJzY3AiOiJBUElDb25uZWN0b3JzLlJlYWQuQWxsIEFQSUNvbm5lY3RvcnMuUmVhZFdyaXRlLkFsbCBDYWxlbmRhcnMuUmVhZFdyaXRlIENoYXQuUmVhZCBDaGF0LlJlYWRCYXNpYyBDb250YWN0cy5SZWFkV3JpdGUgRGV2aWNlTWFuYWdlbWVudFJCQUMuUmVhZC5BbGwgRGV2aWNlTWFuYWdlbWVudFNlcnZpY2VDb25maWcuUmVhZC5BbGwgRmlsZXMuUmVhZFdyaXRlLkFsbCBHcm91cC5SZWFkV3JpdGUuQWxsIElkZW50aXR5Umlza0V2ZW50LlJlYWQuQWxsIE1haWwuUmVhZCBNYWlsLlJlYWRXcml0ZSBNYWlsYm94U2V0dGluZ3MuUmVhZFdyaXRlIE5vdGVzLlJlYWRXcml0ZS5BbGwgb3BlbmlkIFBlb3BsZS5SZWFkIFBsYWNlLlJlYWQgUHJlc2VuY2UuUmVhZCBQcmVzZW5jZS5SZWFkLkFsbCBQcmludGVyU2hhcmUuUmVhZEJhc2ljLkFsbCBQcmludEpvYi5DcmVhdGUgUHJpbnRKb2IuUmVhZEJhc2ljIHByb2ZpbGUgUmVwb3J0cy5SZWFkLkFsbCBTaXRlcy5SZWFkV3JpdGUuQWxsIFN5bmNocm9uaXphdGlvbi5SZWFkV3JpdGUuQWxsIFRhc2tzLlJlYWRXcml0ZSBVc2VyLlJlYWQgVXNlci5SZWFkQmFzaWMuQWxsIFVzZXIuUmVhZFdyaXRlIFVzZXIuUmVhZFdyaXRlLkFsbCBlbWFpbCBVc2VyQXV0aGVudGljYXRpb25NZXRob2QuUmVhZFdyaXRlLkFsbCIsInNpZCI6IjAwMmY1NTQ5LTJmOTEtNGRkZC0yYzkyLTE2MDBlNTc5ZDU0ZiIsInN1YiI6IlFELU8wOTRWb2o1UzRsZzBVZTQtU01HNS1jSmhma2tudDdiQThWMDJILTAiLCJ0ZW5hbnRfcmVnaW9uX3Njb3BlIjoiQVMiLCJ0aWQiOiIxOTVlODk2OS1jODUzLTQ3YjQtODNkMC0zNmUwNDRkODM5MjMiLCJ1bmlxdWVfbmFtZSI6IkdBZG1pbkBhbWl0b21hcjYzZ21haWwub25taWNyb3NvZnQuY29tIiwidXBuIjoiR0FkbWluQGFtaXRvbWFyNjNnbWFpbC5vbm1pY3Jvc29mdC5jb20iLCJ1dGkiOiJpOGxhN1hyODdVLWJnWEQ1Yno0aEFBIiwidmVyIjoiMS4wIiwid2lkcyI6WyI2MmU5MDM5NC02OWY1LTQyMzctOTE5MC0wMTIxNzcxNDVlMTAiLCJiNzlmYmY0ZC0zZWY5LTQ2ODktODE0My03NmIxOTRlODU1MDkiXSwieG1zX2NjIjpbIkNQMSJdLCJ4bXNfZnRkIjoiRDJhVmNGUE1KSkJ0ZVdVSFhJdU9PdWVQR0xQdngxeGcxb3RDZEtjb0FhWSIsInhtc19pZHJlbCI6IjEgMTgiLCJ4bXNfc3NtIjoiMSIsInhtc19zdCI6eyJzdWIiOiJmZnVKZHpTVFQ1TC1NSjhYY002b2N4RW5DaVMtNTBOQVF0MWNqb212bVRzIn0sInhtc190Y2R0IjoxNjc4ODgwMDQwfQ.gevHVBxkUpRaV2ppmYWVLLLnjhr7_xWwanB_1eJjZS38njeLoRvAKyX2Z6fPtxxtVU-8XGfCEYA2fCRfqNRY4mUV1iLHjnb1NhrYrRRqftPemGmlQNatTpErtaBNNbdjgZ27jV7UenWRyFMW-3QHdwLUGPubcdA9oCps4Y6fLSGexiyoL4NXyxUuSEKuuwdW7Mm44OGxCkM3HheOx2LuspXtuY_MNodJmk9B4mjzYRLURkhd2E44ykE13MwZIVLP0NJJ0derr3UOeheaan5dbcDg9SWjkVugo1jlUtfl_YzgPmO7hGi8wOXEV1XAt33f8zuOeKvjgOXioUuQMvHEqw"  # Replace with a valid token
    password_reset_endpoint: "https://graph.microsoft.com/v1.0/users/d8108922-a5e1-415b-974b-9022ba4e492e/authentication/methods/28c10230-6103-485e-b985-444c60001490/resetPassword"
 
  tasks:
    - name: Reset Password via Microsoft Graph API
      uri:
        url: "{{ password_reset_endpoint }}"
        method: POST
        headers:
          Authorization: "Bearer {{ access_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          password: ""
          forceChangePasswordNextSignIn: true
        status_code: [202, 204]  # Accept both 202 (async) and 204 (success)
      register: password_reset_response
 
    - name: Extract new password if available
      set_fact:
        new_temp_password: "{{ password_reset_response.json.newPassword | default('Not Provided') }}"
 
    - name: Debug Password Reset Response
      debug:
        msg:
          - "Password reset attempted"
          - "Temporary Password: {{ new_temp_password }}"
          - "Response: {{ password_reset_response }}"
